# 增强版网盘搜索插件使用说明

## 🎯 新功能特性

### 1. 多种触发方式
- `搜XX` - 例如：搜仙逆
- `求XX` - 例如：求速度与激情
- `搜索XX` - 例如：搜索复仇者联盟
- `找XX` - 例如：找权力的游戏
- `/搜索XX` - 例如：/搜索仙逆
- `/search XX` - 例如：/search 仙逆

### 2. 分页浏览
- 每页显示 5 个结果
- 支持「下一页」翻页
- 支持「上一页」翻页
- 显示当前页码和总页数

### 3. 选择转存
- 显示序号（1, 2, 3...）
- 显示网盘类型（百度网盘、夸克网盘、UC网盘、迅雷网盘等）
- 用户输入「第X个」或「X」选择资源
- 选择后自动转存并返回链接

### 4. 支持多种网盘
- 百度网盘
- 夸克网盘
- 阿里云盘
- UC网盘
- 迅雷网盘
- 天翼云盘
- 移动云盘
- 115网盘
- PikPak
- 123网盘
- 磁力链接
- 电驴链接

## 📝 使用流程示例

### 用户交互流程

```
用户: 搜仙逆
机器人: 🔍 搜索结果（共 1265 个，第 1/253 页）

【1】仙逆剧场版神临之战.2025
    📦 百度网盘

【2】仙逆(2023)【最新一集】【4K.臻彩】
    📦 百度网盘

【3】【短剧】仙逆（115集全集）
    📦 百度网盘

【4】仙逆
    📦 夸克网盘

【5】仙逆
    📦 UC网盘

💡 输入「下一页」或「上一页」翻页
💡 输入「第X个」或「X」选择资源（如：第1个、1）

用户: 下一页
机器人: 🔍 搜索结果（共 1265 个，第 2/253 页）

【6】仙逆 全集
    📦 迅雷网盘

【7】仙逆 4K版本
    📦 百度网盘

...

用户: 第4个
机器人: ⏳ 正在转存第 4 个资源...
📦 类型: 夸克网盘

✅ 转存成功！

📝 标题: 仙逆
🔗 链接: https://pan.quark.cn/s/转存后的链接
🔑 提取码: 1234
📦 网盘: 夸克网盘
```

## 🔧 集成到 astrbot

### 基础集成

```python
from pansearch_enhanced import PanSearchPluginEnhanced
import json

# 初始化插件（在机器人启动时）
with open('config.json', 'r', encoding='utf-8') as f:
    config = json.load(f)
plugin = PanSearchPluginEnhanced(config)

# 在消息处理函数中
def on_message(message, user_id):
    """消息处理函数"""
    reply = plugin.handle_message(message, user_id)
    return reply
```

### 完整集成示例

```python
from pansearch_enhanced import PanSearchPluginEnhanced
import json
import logging

# 配置日志
logging.basicConfig(level=logging.INFO)

# 初始化插件
with open('config.json', 'r', encoding='utf-8') as f:
    config = json.load(f)
plugin = PanSearchPluginEnhanced(config)

def on_message(message: str, user_id: str, group_id: str = None):
    """
    消息处理函数
    
    Args:
        message: 用户消息
        user_id: 用户ID（重要：用于会话管理）
        group_id: 群ID（可选）
    """
    try:
        # 使用用户ID进行会话管理
        # 如果是群聊，可以使用 group_id + user_id 组合作为唯一标识
        session_id = f"{group_id}_{user_id}" if group_id else user_id
        
        reply = plugin.handle_message(message, session_id)
        return reply
    except Exception as e:
        logging.error(f"消息处理异常: {e}")
        return f"❌ 处理失败: {str(e)}"
```

## 📋 支持的命令

### 搜索命令
- `搜XX` - 搜索资源
- `求XX` - 搜索资源
- `搜索XX` - 搜索资源
- `找XX` - 搜索资源
- `/搜索XX` - 搜索资源
- `/search XX` - 搜索资源

### 翻页命令
- `下一页` / `下一頁` / `next` / `下页` - 查看下一页
- `上一页` / `上一頁` / `prev` / `previous` / `上页` - 查看上一页

### 选择命令
- `第X个` / `第X個` - 选择第X个资源（如：第1个）
- `X` - 直接输入数字（如：1）
- `选择X` / `選擇X` - 选择第X个资源

## ⚙️ 配置说明

配置文件 `config.json`：

```json
{
  "pansou_api_url": "http://154.12.83.97:8085",
  "ziliao_api_url": "https://www.ziliao.xyz",
  "ziliao_api_path": "/api/open/transfer",
  "ziliao_api_key": "",
  "max_results": 50,
  "timeout": 30
}
```

**注意**：`max_results` 现在表示最大搜索和提取的结果数（建议设置为 50 或更大）

## 🎨 输出格式

### 搜索结果格式

```
🔍 搜索结果（共 1265 个，第 1/253 页）

【1】仙逆剧场版神临之战.2025
    📦 百度网盘

【2】仙逆(2023)【最新一集】【4K.臻彩】
    📦 百度网盘

【3】【短剧】仙逆（115集全集）
    📦 百度网盘

【4】仙逆
    📦 夸克网盘

【5】仙逆
    📦 UC网盘

💡 输入「下一页」或「上一页」翻页
💡 输入「第X个」或「X」选择资源（如：第1个、1）
```

### 转存成功格式

```
✅ 转存成功！

📝 标题: 仙逆剧场版神临之战
🔗 链接: https://pan.baidu.com/s/转存后的链接
🔑 提取码: 6666
📦 网盘: 百度网盘
```

## 🔄 会话管理

- 每个用户有独立的会话
- 会话保存搜索结果和当前页码
- 会话10分钟后自动过期
- 转存完成后自动清除会话

## 🧪 测试

运行测试脚本：

```bash
python pansearch_enhanced.py
```

## 📌 注意事项

1. **用户ID**：必须为每个用户提供唯一的 user_id，用于会话管理
2. **群聊处理**：如果是群聊，建议使用 `group_id + user_id` 作为会话ID
3. **会话过期**：搜索结果会在10分钟后过期，需要重新搜索
4. **结果数量**：建议设置较大的 `max_results` 值（如50）以获取更多结果

